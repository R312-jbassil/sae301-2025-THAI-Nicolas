---
import Layout from '../layouts/Layout.astro';
import BoutonCirculaire from '../components/boutons/BoutonCirculaire.astro';
import BoutonConfigurateur from '../components/boutons/BoutonConfigurateur.astro';
import MainBouton from '../components/boutons/MainBouton.astro';
import ModalInfos from '../components/modals/ModalInfos.astro';
import ModalAjoutPanier from '../components/modals/ModalAjoutPanier.astro';
import ModalChatIA from '../components/modals/ModalChatIA.astro';
import ModalConfirm from '../components/modals/ModalConfirm.astro';
import ModalAuthRequired from '../components/modals/ModalAuthRequired.astro';
import Logo from '../assets/icones/logo.svg';
import IconIa from '../assets/icones/ia.svg';
import LunettesSVG from '../assets/lunettes.svg';
import SelectConfigurateur from '../components/configurateur/SelectConfigurateur.astro';
import Chevron from '../assets/icones/chevron.svg';
import IconPanier from '../assets/icones/panier.svg';
---

<Layout title="Configurateur - TaVue" description="Configurez vos lunettes personnalis√©es">
  <div class="h-screen flex bg-neutral-100 overflow-hidden">
    <!-- Partie gauche - Visualisation 3D -->
    <div class="w-2/3 flex flex-col items-start justify-between px-20 py-16 overflow-hidden">
      <!-- Header avec logo et boutons -->
      <div class="flex items-start justify-between w-full mb-16">
        <!-- Logo -->
        <a href="/" class="transition-transform duration-300 hover:scale-110 active:scale-95 cursor-pointer">
          <img src={Logo.src} alt="TaVue" class="w-28 h-auto" />
        </a>

      </div>

      <!-- Lunettes principale -->
      <div class="flex-1 flex items-center justify-center w-full relative overflow-hidden">
        <!-- Lunettes -->
        <!-- 
          üí° Pour ajuster la position des lunettes :
          - Modifier la classe "mt-32" ci-dessous pour changer la position verticale
            (mt-32 = margin-top de 8rem = 128px)
            Valeurs disponibles : mt-0, mt-4, mt-8, mt-12, mt-16, mt-20, mt-24, mt-28, mt-32, mt-36, mt-40
          - Utiliser translate-y-[valeur] pour un ajustement plus pr√©cis
            Exemple : translate-y-20 (vers le bas), -translate-y-20 (vers le haut)
        -->
        <div class="w-full max-w-4xl mt-120" id="lunettes-container">
          <svg id="lunettes-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" viewBox="0 0 595.28 841.89" class="w-full h-auto">
            <defs>
              <style>
                .cls-1 {
                  fill: #706f6f;
                  mix-blend-mode: multiply;
                }

                .cls-2 {
                  isolation: isolate;
                }

                .cls-3, .cls-4 {
                  fill: #ffffff;
                }

                .cls-4 {
                  stroke: #1d1d1b;
                  stroke-miterlimit: 10;
                  stroke-width: .5px;
                }

                .cls-5 {
                  fill: none;
                  opacity: .75;
                }
              </style>
            </defs>
            <g class="cls-2">
              <g id="branches">
                <path class="cls-4" d="M108.83,155.14s49.35-5.57,54.93-8.76,11.14-7.96,19.5-9.55,64.48-11.14,64.48-11.14c0,0,7.16-1.99,17.51,5.57s33.04,31.84,39.4,31.05c6.37-.8,9.55-9.55,7.56-13.53s-40.67-32.75-47.36-34.63c-9.53-2.68-21.89-2.39-37.02,0-15.12,2.39-116.22,23.34-116.22,23.34,0,0-13.13,6.12-2.79,17.66Z"/>
                <path class="cls-1" d="M308.24,150.76s-.31,6.15-3.98,5.57c-4.97-.78-35.82-33.83-46.17-32.24,0,0,8.53,2.71,18.46,11.64,6.51,5.86,34.42,37.85,31.69,15.03Z"/>
                <path class="cls-4" d="M374.79,179.65l90.54-29.78s22.13-5.63,25.35-4.02,17.71,30.58,17.71,33.8-2.42,14.01-5.63,14.89c-2.33.64-5.33.11-6.84-4.21-1.41-4.02-6.84-31.73-12.47-31.47s-50.7,15.95-50.7,15.95c0,0-13.28,6.44-18.91,11.27s-32.19,11.27-32.19,11.27c0,0-9.66-7.65-6.84-17.71Z"/>
                <path class="cls-1" d="M381.34,180.1s102.27-35.19,107.85-31.99c0,0-18.2,2.49-41.76,11.88s-66.09,22.03-66.09,22.03v-1.92Z"/>
                <path class="cls-1" d="M485.36,158.06s3.26,0,4.98,3.45,9.77,24.71,9.77,24.71c0,0,.77,4.98,5.17-2.68,0,0-3.07,9.56-5.36,6.79s-9.77-26.33-9.77-26.33c0,0-2.87-6.74-4.79-5.94Z"/>
              </g>
              <g id="monture">
                <path class="cls-4" d="M385.31,180.81c-.24-3.41-9.57-5.22-12.71-6.4-3.14-1.18-15.7,1.96-15.7,1.96-12.17-3.14-54.55-9.03-78.88-9.03s-32.57,11.38-35.32,10.99c-2.75-.39-17.27-.78-23.55-1.96-6.28-1.18-5.1-14.13-39.25-26.48-34.14-12.35-68.29-12.42-68.29-12.42-13.35,4.66-6.76,18.49-6.76,18.49l2.05,6.35c4.32,2.03,3.14,10.52,4.71,23.08s7.46,28.65,14.13,38.46c6.67,9.81,31.79,20.8,44.35,21.19s23.55-1.96,31.79-15.31c8.24-13.34,16.88-36.89,16.88-36.89l10.2,1.57s2.91.31,5.35,3.09,4.43,8.03,7.6,17.31c7.56,22.1,25.12,39.25,25.12,39.25,0,0,5.6,7.43,33.44,12.66,23.08,4.34,42.7-2.46,42.7-2.46,17.72-7.17,21.63-44.96,21.63-44.96,0,0,1.83-13.3,7.81-16.65,7.37-4.14,8.27-4.44,12.71-5.32,3.61-.71.24-13.13,0-16.54ZM190.5,231.32c-9.42,5.1-32.18,7.06-46.31-3.92-14.13-10.99-20.8-30.22-22.76-52.98s7.1-25.23,7.1-25.23c0,0,14.88-.67,34.11,4.03,19.23,4.71,40.42,18.05,40.82,26.69.39,8.63-3.53,46.31-12.95,51.41ZM344.73,255.65c-9.03,4.32-21.47,4.71-31.93,3.92-10.46-.78-37.54-1.57-47.35-31.4,0,0-2.75-14.13-5.1-17.27-2.35-3.14-9.42-14.48-9.42-18.43,0-8.23,7.15-12.97,7.15-12.97,0,0,8.16-5.1,18.75-5.1,10.6,0,64.75,2.75,72.21,12.95,7.46,10.2,7.06,21.98,8.24,31.4,1.18,9.42-3.53,32.57-12.56,36.89Z"/>
              </g>
              <g id="verres">
                <path class="cls-5" d="M116.32,162.87c-.88,6.05.4,37.41,11.44,55.31s37.04,21.35,41.37,21.31,18.51,1.02,24.47-9.27c4.97-8.59,13.17-43.48,9.12-53.05-6.26-14.82-40.4-24.02-40.4-24.02,0,0-26.85-5.46-33.82-4.46,0,0-9.97-.96-12.17,14.17Z"/>
                <path class="cls-5" d="M247.32,192.54s-1.09-9.55,19.57-16.69c11.76-4.06,60.46,3.23,60.46,3.23,0,0,19.09,4.06,21.71,8.28,2.62,4.22,9.46,17.24,8.29,37.97-1.14,20.21-7.31,26.8-12.61,30.31,0,0-7.1,4.93-21.34,5.93-26.65,1.88-37.01-1.14-46.19-7.73-29.88-21.46-29.88-61.3-29.88-61.3Z"/>
              </g>
            </g>
          </svg>
        </div>
      </div>
    </div>

    <!-- Partie droite - Configuration -->
    <div class="w-1/3 bg-white shadow-lg flex flex-col h-screen overflow-hidden">
      <!-- Configuration (scrollable) -->
      <div class="flex-1 overflow-y-auto px-12 py-12">
        <!-- Header -->
        <div class="flex items-center justify-between mb-8">
          <div class="flex-1">
            <input 
              type="text" 
              id="config-name-input"
              value="√âL√âGANCE"
              class="text-4xl font-bold text-noir tracking-widest bg-transparent border-2 border-transparent hover:border-gray-200 focus:border-vert rounded-lg px-3 py-1 -ml-3 outline-none transition-all duration-200 w-full max-w-md uppercase"
              placeholder="NOM DE LA CONFIGURATION"
              maxlength="30"
            />
          </div>
          <div id="open-info-modal" class="cursor-pointer">
            <BoutonCirculaire icone="infos" taille="small" />
          </div>
        </div>

        <!-- Taille -->
        <div class="border-b border-gray-200 pb-8 mb-8">
          <div class="flex items-center justify-between">
            <p class="text-xl font-semibold text-noir">TAILLE</p>
            <div class="flex items-center gap-5">
              <button class="hover:text-vert transition-colors cursor-pointer" id="size-decrease">
                <img src={Chevron.src} alt="Pr√©c√©dent" class="w-full h-2.5 -rotate-90" />
              </button>
              <span class="text-lg font-medium text-noir" id="size-display">52-18</span>
              <button class="hover:text-vert transition-colors cursor-pointer" id="size-increase">
                <img src={Chevron.src} alt="Suivant" class="w-full h-2.5 rotate-90" />
              </button>
            </div>
          </div>
        </div>

        <!-- Onglets -->
        <div class="flex gap-3 mb-8" id="category-tabs">
          <BoutonConfigurateur texte="VERRES" isActive={true} />
          <BoutonConfigurateur texte="MONTURE" isActive={false} />
          <BoutonConfigurateur texte="BRANCHES" isActive={false} />
          <BoutonConfigurateur texte="ETUI" isActive={false} />
        </div>

        <!-- Contenu pour VERRES -->
        <div id="content-verres" class="category-content">
          <!-- Type de verres -->
          <div class="mb-8 accordion-section">
            <button class="flex items-center justify-between w-full mb-6 accordion-trigger cursor-pointer" data-accordion="type-verres">
              <h3 class="text-xl font-semibold text-noir">TYPE DE VERRES</h3>
              <img src={Chevron.src} alt="D√©plier" class="w-4.5 h-2.5 accordion-chevron transition-transform duration-300" />
            </button>

            <div class="accordion-content overflow-hidden transition-all duration-300" data-accordion-content="type-verres">
              <div class="space-y-4">
                <SelectConfigurateur 
                  titre="Correcteurs"
                  isSelected={true}
                />
                <SelectConfigurateur 
                  titre="Solaires"
                  isSelected={false}
                />
                <SelectConfigurateur 
                  titre="Photochromiques"
                  prix={80}
                  isSelected={false}
                />
                <SelectConfigurateur 
                  titre="Polaris√©s"
                  prix={40}
                  isSelected={false}
                />
              </div>
            </div>
          </div>

          <!-- Couleur des verres -->
          <div class="mb-8 accordion-section">
            <button class="flex items-center justify-between w-full mb-6 accordion-trigger cursor-pointer" data-accordion="couleur-verres">
              <h3 class="text-xl font-semibold text-noir">COULEUR DES VERRES</h3>
              <img src={Chevron.src} alt="D√©plier" class="w-4.5 h-2.5 accordion-chevron transition-transform duration-300" />
            </button>

            <div class="accordion-content overflow-hidden transition-all duration-300" data-accordion-content="couleur-verres">
              <div class="flex gap-4 items-center">
                <button class="w-12 h-12 rounded-full bg-gris border-2 border-noir cursor-pointer"></button>
                <button class="w-12 h-12 rounded-full bg-[#8b5a3c] border-2 border-border hover:border-noir transition-colors cursor-pointer"></button>
                <button class="w-12 h-12 rounded-full bg-[#7fa5c1] border-2 border-border hover:border-noir transition-colors cursor-pointer"></button>
                <button class="w-12 h-12 rounded-full bg-[#c8a882] border-2 border-border hover:border-noir transition-colors cursor-pointer"></button>
                <button class="w-12 h-12 rounded-full bg-[#d4a5a5] border-2 border-border hover:border-noir transition-colors cursor-pointer"></button>
                <label class="w-12 h-12 rounded-full border-2 border-vert hover:border-noir transition-colors cursor-pointer relative overflow-hidden flex items-center justify-center group">
                  <input type="color" class="color-picker-verres absolute inset-0 opacity-0 cursor-pointer" value="#4A5A54" />
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-vert group-hover:text-noir transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                  </svg>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Contenu pour MONTURE -->
        <div id="content-monture" class="category-content hidden">
          <!-- Forme de monture -->
          <div class="mb-8 accordion-section">
            <button class="flex items-center justify-between w-full mb-6 accordion-trigger cursor-pointer" data-accordion="forme-monture">
              <h3 class="text-xl font-semibold text-noir">FORME DE MONTURE</h3>
              <img src={Chevron.src} alt="D√©plier" class="w-4.5 h-2.5 accordion-chevron transition-transform duration-300" />
            </button>

            <div class="accordion-content overflow-hidden transition-all duration-300" data-accordion-content="forme-monture">
              <div class="space-y-4">
                <SelectConfigurateur 
                  titre="Rectangulaire"
                  isSelected={true}
                />
                <SelectConfigurateur 
                  titre="Ronde"
                  isSelected={false}
                />
                <SelectConfigurateur 
                  titre="Papillon"
                  isSelected={false}
                />
                <SelectConfigurateur 
                  titre="Carr√©e"
                  isSelected={false}
                />
              </div>
            </div>
          </div>

          <!-- Couleur de monture -->
          <div class="mb-8 accordion-section">
            <button class="flex items-center justify-between w-full mb-6 accordion-trigger cursor-pointer" data-accordion="couleur-monture">
              <h3 class="text-xl font-semibold text-noir">COULEUR DE MONTURE</h3>
              <img src={Chevron.src} alt="D√©plier" class="w-4.5 h-2.5 accordion-chevron transition-transform duration-300" />
            </button>

            <div class="accordion-content overflow-hidden transition-all duration-300" data-accordion-content="couleur-monture">
              <div class="flex gap-4 items-center">
                <button class="w-12 h-12 rounded-full bg-noir border-2 border-noir cursor-pointer"></button>
                <button class="w-12 h-12 rounded-full bg-[#8b5a3c] border-2 border-border hover:border-noir transition-colors cursor-pointer"></button>
                <button class="w-12 h-12 rounded-full bg-[#c8a882] border-2 border-border hover:border-noir transition-colors cursor-pointer"></button>
                <button class="w-12 h-12 rounded-full bg-vert border-2 border-border hover:border-noir transition-colors cursor-pointer"></button>
                <label class="w-12 h-12 rounded-full border-2 border-vert hover:border-noir transition-colors cursor-pointer relative overflow-hidden flex items-center justify-center group">
                  <input type="color" class="color-picker-monture absolute inset-0 opacity-0 cursor-pointer" value="#1A1A1A" />
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-vert group-hover:text-noir transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                  </svg>
                </label>
              </div>
            </div>
          </div>

          <!-- √âpaisseur -->
          <div class="mb-8 accordion-section">
            <button class="flex items-center justify-between w-full mb-6 accordion-trigger cursor-pointer" data-accordion="epaisseur">
              <h3 class="text-xl font-semibold text-noir">√âPAISSEUR</h3>
              <img src={Chevron.src} alt="D√©plier" class="w-4.5 h-2.5 accordion-chevron transition-transform duration-300" />
            </button>

            <div class="accordion-content overflow-hidden transition-all duration-300" data-accordion-content="epaisseur">
              <div class="space-y-4">
                <SelectConfigurateur 
                  titre="Fin"
                  isSelected={false}
                />
                <SelectConfigurateur 
                  titre="Moyen"
                  isSelected={true}
                />
                <SelectConfigurateur 
                  titre="√âpais"
                  isSelected={false}
                />
              </div>
            </div>
          </div>

          <!-- Mat√©riau -->
          <div class="mb-8 accordion-section">
            <button class="flex items-center justify-between w-full mb-6 accordion-trigger cursor-pointer" data-accordion="materiau">
              <h3 class="text-xl font-semibold text-noir">MAT√âRIAU</h3>
              <img src={Chevron.src} alt="D√©plier" class="w-4.5 h-2.5 accordion-chevron transition-transform duration-300" />
            </button>

            <div class="accordion-content overflow-hidden transition-all duration-300" data-accordion-content="materiau">
              <div class="space-y-4" id="materiaux-list">
                <!-- Les mat√©riaux seront charg√©s dynamiquement depuis PocketBase -->
                <div class="text-center py-4 text-gris">
                  <p>Chargement des mat√©riaux...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Contenu pour BRANCHES -->
        <div id="content-branches" class="category-content hidden">
          <!-- Couleur des branches -->
          <div class="mb-8 accordion-section">
            <button class="flex items-center justify-between w-full mb-6 accordion-trigger cursor-pointer" data-accordion="couleur-branches">
              <h3 class="text-xl font-semibold text-noir">COULEUR DES BRANCHES</h3>
              <img src={Chevron.src} alt="D√©plier" class="w-4.5 h-2.5 accordion-chevron transition-transform duration-300" />
            </button>

            <div class="accordion-content overflow-hidden transition-all duration-300" data-accordion-content="couleur-branches">
              <div class="flex gap-4 items-center">
                <button class="w-12 h-12 rounded-full bg-noir border-2 border-noir cursor-pointer"></button>
                <button class="w-12 h-12 rounded-full bg-vert border-2 border-border hover:border-noir transition-colors cursor-pointer"></button>
                <button class="w-12 h-12 rounded-full bg-[#c8a882] border-2 border-border hover:border-noir transition-colors cursor-pointer"></button>
                <button class="w-12 h-12 rounded-full bg-gray-400 border-2 border-border hover:border-noir transition-colors cursor-pointer"></button>
                <button class="w-12 h-12 rounded-full bg-[#8b5a3c] border-2 border-border hover:border-noir transition-colors cursor-pointer"></button>
                <button class="w-12 h-12 rounded-full bg-[#d4a5a5] border-2 border-border hover:border-noir transition-colors cursor-pointer"></button>
                <label class="w-12 h-12 rounded-full border-2 border-vert hover:border-noir transition-colors cursor-pointer relative overflow-hidden flex items-center justify-center group">
                  <input type="color" class="color-picker-branches absolute inset-0 opacity-0 cursor-pointer" value="#1A1A1A" />
                  <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-vert group-hover:text-noir transition-colors" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" />
                  </svg>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Contenu pour ETUI -->
        <div id="content-etui" class="category-content hidden">
          <p class="text-gray-500 text-center py-8">Contenu √©tui √† venir...</p>
        </div>
      </div>

      <!-- Footer fixe -->
      <div class="border-t border-gray-200 px-12 py-10 bg-white flex-shrink-0">
        <!-- Prix et compte -->
        <div class="flex items-center justify-between mb-6">
          <button class="flex items-center gap-3 text-noir hover:text-vert transition-colors cursor-pointer">
            <img src={Chevron.src} alt="Suivant" class="w-4 h-2.5 rotate-90" />
            <span class="text-lg font-medium tracking-wide">CR√âER UN COMPTE</span>
          </button>
          <p class="text-3xl font-bold text-noir">149‚Ç¨</p>
        </div>

        <!-- Bouton sauvegarde avec CTA √©motionnel -->
        <div id="open-cart-modal" class="w-full cursor-pointer">
          <MainBouton 
            variant="primary"
            texte="SAUVEGARDER MON MOD√àLE UNIQUE"
            icone="panier"
            class="w-full"
          />
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <ModalInfos id="info-modal" />
  <ModalAjoutPanier id="cart-modal" />
  <ModalChatIA id="chat-modal" />
  <ModalAuthRequired id="auth-required-modal" />
  <ModalConfirm 
    id="reset-chat-confirm" 
    title="R√©initialiser la conversation ?"
    message="Voulez-vous vraiment r√©initialiser la conversation ? Cet historique sera sauvegard√© mais une nouvelle conversation sera cr√©√©e."
  />

  <!-- Bouton circulaire Chat IA (en bas √† gauche) -->
  <button 
    id="open-chat-btn"
    class="fixed bottom-8 left-8 w-16 h-16 bg-vert rounded-full shadow-2xl hover:scale-110 transition-all duration-300 flex items-center justify-center z-40 hover:shadow-vert/50 group cursor-pointer"
    title="Ouvrir le chat IA"
  >
    <img src={IconIa.src} alt="IA" class="w-8 h-8 group-hover:scale-110 transition-transform brightness-0 invert" />
    <!-- Badge de notification (optionnel) -->
    <span class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 rounded-full flex items-center justify-center text-white text-xs font-bold animate-pulse">
      !
    </span>
  </button>

  <!-- Script pour g√©rer la fermeture des modals -->
  <script>
    // Gestion de la fermeture des modals
    document.addEventListener('DOMContentLoaded', () => {
      // Fermer avec les boutons de fermeture
      document.querySelectorAll('.modal-close').forEach(button => {
        button.addEventListener('click', (e) => {
          const modalId = (e.currentTarget as HTMLElement).getAttribute('data-modal');
          if (modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
              modal.classList.add('hidden');
              document.body.style.overflow = 'auto';
            }
          }
        });
      });

      // Fermer en cliquant sur le fond
      document.querySelectorAll('.modal-infos, .modal-cart').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = 'auto';
          }
        });
      });
      
      // Gestion sp√©cifique pour le chat (pas de fermeture sur fond)
      const chatModal = document.getElementById('chat-modal');
      if (chatModal) {
        const closeBtn = chatModal.querySelector('.modal-close');
        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            chatModal.classList.remove('show');
            setTimeout(() => {
              chatModal.classList.add('hidden');
            }, 300); // Attendre la fin de l'animation
          });
        }
      }

      // Ouvrir le chat IA
      const openChatBtn = document.getElementById('open-chat-btn');
      if (openChatBtn) {
        openChatBtn.addEventListener('click', () => {
          const chatModal = document.getElementById('chat-modal');
          if (chatModal) {
            chatModal.classList.remove('hidden');
            chatModal.classList.add('show');
            // Retirer le badge de notification
            const badge = openChatBtn.querySelector('span');
            if (badge) {
              badge.style.display = 'none';
            }
          }
        });
      }

      // √âchapper pour fermer
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          document.querySelectorAll('.modal-infos:not(.hidden), .modal-cart:not(.hidden)').forEach(modal => {
            modal.classList.add('hidden');
            document.body.style.overflow = 'auto';
          });
        }
      });
    });
  </script>

  <style>
    /* Filtre pour colorer les chevrons en vert */
    .chevron-vert img {
      filter: invert(52%) sepia(22%) saturate(870%) hue-rotate(93deg) brightness(91%) contrast(87%);
    }

    /* Accord√©on - contenu cach√© par d√©faut */
    .accordion-content {
      max-height: 0;
      opacity: 0;
    }

    /* Accord√©on ouvert */
    .accordion-content.open {
      max-height: 1000px;
      opacity: 1;
    }

    /* Rotation du chevron */
    .accordion-chevron.open {
      transform: rotate(180deg);
    }
  </style>

  <script>
    // Gestion des onglets de cat√©gories
    const tabsContainer = document.getElementById('category-tabs');
    if (tabsContainer) {
      tabsContainer.addEventListener('click', (e) => {
        const button = (e.target as HTMLElement).closest('button');
        if (!button) return;

        // Retirer l'√©tat actif de tous les boutons
        const allButtons = tabsContainer.querySelectorAll('button');
        allButtons.forEach(btn => {
          btn.classList.remove('bg-vert', 'text-white');
          btn.classList.add('bg-transparent', 'text-vert');
          btn.setAttribute('aria-pressed', 'false');
        });

        // Activer le bouton cliqu√©
        button.classList.remove('bg-transparent', 'text-vert');
        button.classList.add('bg-vert', 'text-white');
        button.setAttribute('aria-pressed', 'true');

        // R√©cup√©rer le texte du bouton pour afficher le bon contenu
        const buttonText = button.textContent?.trim().toLowerCase() || '';
        
        // Cacher tous les contenus
        document.querySelectorAll('.category-content').forEach(content => {
          content.classList.add('hidden');
        });

        // Afficher le contenu correspondant
        const contentId = `content-${buttonText}`;
        const targetContent = document.getElementById(contentId);
        if (targetContent) {
          targetContent.classList.remove('hidden');
          
          // Ouvrir le premier accord√©on de cette cat√©gorie
          const firstAccordion = targetContent.querySelector('.accordion-trigger');
          if (firstAccordion) {
            const accordionId = firstAccordion.getAttribute('data-accordion');
            const content = targetContent.querySelector(`[data-accordion-content="${accordionId}"]`);
            const chevron = firstAccordion.querySelector('.accordion-chevron');
            
            if (content && chevron) {
              content.classList.add('open');
              chevron.classList.add('open');
            }
          }
        }
      });
    }

    // Gestion des accord√©ons
    const accordionTriggers = document.querySelectorAll('.accordion-trigger');
    
    // Ouvrir le premier accord√©on par d√©faut
    const firstContent = document.querySelector('[data-accordion-content="type-verres"]');
    const firstChevron = document.querySelector('[data-accordion="type-verres"] .accordion-chevron');
    if (firstContent && firstChevron) {
      firstContent.classList.add('open');
      firstChevron.classList.add('open');
    }

    accordionTriggers.forEach(trigger => {
      trigger.addEventListener('click', () => {
        const accordionId = trigger.getAttribute('data-accordion');
        const content = document.querySelector(`[data-accordion-content="${accordionId}"]`);
        const chevron = trigger.querySelector('.accordion-chevron');

        if (!content || !chevron) return;

        // Trouver la section parente (category-content)
        const categorySection = trigger.closest('.category-content');
        if (!categorySection) return;

        // V√©rifier si cet accord√©on est d√©j√† ouvert
        const isOpen = content.classList.contains('open');

        // Fermer tous les accord√©ons de cette section
        const allAccordionsInSection = categorySection.querySelectorAll('.accordion-content');
        const allChevronsInSection = categorySection.querySelectorAll('.accordion-chevron');
        
        allAccordionsInSection.forEach(acc => acc.classList.remove('open'));
        allChevronsInSection.forEach(chev => chev.classList.remove('open'));

        // Si l'accord√©on n'√©tait pas ouvert, l'ouvrir
        if (!isOpen) {
          content.classList.add('open');
          chevron.classList.add('open');
        }
      });
    });

    // Gestion de la s√©lection des options dans les accord√©ons
    document.addEventListener('click', (e) => {
      // Chercher un bouton avec aria-pressed (c'est un SelectConfigurateur)
      const selectButton = (e.target as HTMLElement).closest('button[aria-pressed]');
      if (!selectButton) return;

      // V√©rifier que ce n'est pas un bouton de couleur (qui a rounded-full)
      if (selectButton.classList.contains('rounded-full')) return;

      // Trouver le conteneur space-y-4 parent (qui contient tous les selects du m√™me groupe)
      const selectContainer = selectButton.closest('.space-y-4');
      if (!selectContainer) return;

      // D√©s√©lectionner tous les boutons de ce groupe
      const allSelects = selectContainer.querySelectorAll('button[aria-pressed]');
      allSelects.forEach(btn => {
        btn.classList.remove('border-[#589772]', 'bg-[#f0f7f4]');
        btn.classList.add('border-[#E8E8E8]', 'bg-white');
        btn.setAttribute('aria-pressed', 'false');
      });

      // S√©lectionner le bouton cliqu√©
      selectButton.classList.remove('border-[#E8E8E8]', 'bg-white');
      selectButton.classList.add('border-[#589772]', 'bg-[#f0f7f4]');
      selectButton.setAttribute('aria-pressed', 'true');

      // R√©cup√©rer la valeur depuis l'attribut data-value
      const optionValue = selectButton.getAttribute('data-value') || '';
      
      // D√©terminer quel type d'option a √©t√© s√©lectionn√©
      const accordionContent = selectButton.closest('.accordion-content');
      if (!accordionContent) return;
      
      const accordionId = accordionContent.getAttribute('data-accordion-content');
      
      console.log('Option s√©lectionn√©e:', optionValue, 'dans', accordionId);
      
      // Mettre √† jour la configuration actuelle (en minuscules pour PocketBase)
      if (accordionId === 'type-verres') {
        currentConfig.typeVerres = optionValue.toLowerCase();
        console.log('typeVerres mis √† jour:', currentConfig.typeVerres);
        updatePriceDisplay();
      } else if (accordionId === 'forme-monture') {
        currentConfig.formeMonture = optionValue.toLowerCase();
        console.log('formeMonture mis √† jour:', currentConfig.formeMonture);
      } else if (accordionId === 'epaisseur') {
        currentConfig.epaisseur = optionValue.toLowerCase();
        console.log('epaisseur mis √† jour:', currentConfig.epaisseur);
      } else if (accordionId === 'materiau') {
        // R√©cup√©rer les donn√©es du mat√©riau
        const materiauId = selectButton.getAttribute('data-materiau-id');
        const materiauPrix = parseFloat(selectButton.getAttribute('data-materiau-prix') || '0');
        
        currentConfig.materiauId = materiauId;
        currentConfig.materiauNom = optionValue;
        currentConfig.materiauPrix = materiauPrix;
        
        console.log('mat√©riau mis √† jour:', currentConfig.materiauNom, '+', materiauPrix, '‚Ç¨');
        updatePriceDisplay();
      }
    });

    // √âtat des couleurs
    let currentColors = {
      verres: '#4A5A54', // Gris par d√©faut
      monture: '#1A1A1A', // Noir par d√©faut
      branches: '#1A1A1A' // Noir par d√©faut
    };

    // Configuration actuelle
    let currentConfig = {
      taille: '52-18',
      typeVerres: 'correcteurs',
      couleurVerres: '#4A5A54',
      formeMonture: 'rectangulaire',
      couleurMonture: '#1A1A1A',
      epaisseur: 'moyen',
      couleurBranches: '#1A1A1A',
      materiauId: null as string | null, // ID du mat√©riau s√©lectionn√©
      materiauNom: 'Ac√©tate de cellulose', // Nom pour affichage
      materiauPrix: 0 // Prix suppl√©mentaire
    };

    // Prix de base et suppl√©ments
    const prixBase = 149;
    const prixOptions = {
      typeVerres: {
        'correcteurs': 0,
        'solaires': 0,
        'photochromiques': 80,
        'polaris√©s': 40
      }
    };

    // Fonction pour calculer le prix total
    function calculerPrixTotal() {
      let total = prixBase;
      
      // Ajouter le prix du type de verres
      const typeVerres = currentConfig.typeVerres as keyof typeof prixOptions.typeVerres;
      if (prixOptions.typeVerres[typeVerres] !== undefined) {
        total += prixOptions.typeVerres[typeVerres];
      }
      
      // Ajouter le prix du mat√©riau
      if (currentConfig.materiauPrix) {
        total += currentConfig.materiauPrix;
      }
      
      return total;
    }

    // Fonction pour mettre √† jour l'affichage du prix
    function updatePriceDisplay() {
      const priceElement = document.querySelector('.text-3xl.font-bold.text-noir');
      if (priceElement) {
        priceElement.textContent = `${calculerPrixTotal()}‚Ç¨`;
      }
    }

    // Fonction pour appliquer les couleurs au SVG
    function applySVGColors() {
      const svg = document.getElementById('lunettes-svg');
      if (!svg) return;

      // Appliquer la couleur des verres
      const verresGroup = svg.querySelector('#verres');
      if (verresGroup) {
        const verresPaths = verresGroup.querySelectorAll('path');
        verresPaths.forEach(pathEl => {
          const path = pathEl as SVGPathElement;
          path.style.fill = currentColors.verres;
          path.style.opacity = '0.5'; // Pour voir √† travers
        });
      }

      // Appliquer la couleur de la monture
      const montureGroup = svg.querySelector('#monture');
      if (montureGroup) {
        const monturePaths = montureGroup.querySelectorAll('path.cls-4');
        monturePaths.forEach(pathEl => {
          const path = pathEl as SVGPathElement;
          path.style.fill = currentColors.monture;
          path.style.stroke = currentColors.monture;
        });
      }

      // Appliquer la couleur des branches
      const branchesGroup = svg.querySelector('#branches');
      if (branchesGroup) {
        const branchesPaths = branchesGroup.querySelectorAll('path.cls-4');
        branchesPaths.forEach(pathEl => {
          const path = pathEl as SVGPathElement;
          path.style.fill = currentColors.branches;
          path.style.stroke = currentColors.branches;
        });
      }
    }

    // Exposer les fonctions et variables globalement pour les autres scripts
    (window as any).currentConfig = currentConfig;
    (window as any).currentColors = currentColors;
    (window as any).calculerPrixTotal = calculerPrixTotal;
    (window as any).applySVGColors = applySVGColors;
    (window as any).updatePriceDisplay = updatePriceDisplay;

    // Fonction pour charger les mat√©riaux depuis PocketBase
    async function loadMateriaux() {
      const { getMateriaux } = await import('../utils/pb');
      const result = await getMateriaux();
      
      if (result.success && result.materiaux) {
        const materiauxList = document.getElementById('materiaux-list');
        if (!materiauxList) return;
        
        // Vider le message de chargement
        materiauxList.innerHTML = '';
        
        // Cr√©er un bouton pour chaque mat√©riau
        result.materiaux.forEach((materiau: any, index: number) => {
          const button = document.createElement('button');
          button.className = `w-full px-6 py-4 rounded-xl border-2 transition-all duration-200 hover:shadow-md flex items-center justify-between ${
            index === 0 ? 'border-[#589772] bg-[#f0f7f4]' : 'border-[#E8E8E8] bg-white'
          }`;
          button.setAttribute('aria-pressed', index === 0 ? 'true' : 'false');
          button.setAttribute('data-value', materiau.libelle);
          button.setAttribute('data-materiau-id', materiau.id);
          button.setAttribute('data-materiau-prix', materiau.prix_supplementaire.toString());
          
          const leftDiv = document.createElement('div');
          leftDiv.className = 'flex items-center gap-3';
          
          const span = document.createElement('span');
          span.className = 'font-medium text-noir';
          span.textContent = materiau.libelle;
          
          leftDiv.appendChild(span);
          button.appendChild(leftDiv);
          
          // Afficher le prix suppl√©mentaire si > 0
          if (materiau.prix_supplementaire > 0) {
            const priceSpan = document.createElement('span');
            priceSpan.className = 'text-sm text-vert font-semibold';
            priceSpan.textContent = `+${materiau.prix_supplementaire}‚Ç¨`;
            button.appendChild(priceSpan);
          }
          
          materiauxList.appendChild(button);
          
          // S√©lectionner le premier mat√©riau par d√©faut
          if (index === 0) {
            currentConfig.materiauId = materiau.id;
            currentConfig.materiauNom = materiau.libelle;
            currentConfig.materiauPrix = materiau.prix_supplementaire;
          }
        });
        
        updatePriceDisplay(); // Mettre √† jour le prix apr√®s chargement
      } else {
        console.error('Erreur chargement mat√©riaux:', result.error);
        const materiauxList = document.getElementById('materiaux-list');
        if (materiauxList) {
          materiauxList.innerHTML = '<div class="text-center py-4 text-red-500"><p>Erreur de chargement des mat√©riaux</p></div>';
        }
      }
    }

    // Appliquer les couleurs au chargement
    document.addEventListener('DOMContentLoaded', () => {
      applySVGColors();
      updatePriceDisplay(); // Initialiser le prix au chargement
      loadMateriaux(); // Charger les mat√©riaux depuis PocketBase

      // Gestion des color pickers personnalis√©s
      const colorPickerVerres = document.querySelector('.color-picker-verres');
      const colorPickerMonture = document.querySelector('.color-picker-monture');
      const colorPickerBranches = document.querySelector('.color-picker-branches');

      if (colorPickerVerres) {
        colorPickerVerres.addEventListener('input', (e) => {
          const target = e.target as HTMLInputElement;
          const customColor = target.value;
          currentColors.verres = customColor;
          currentConfig.couleurVerres = customColor;
          applySVGColors();
        });
      }

      if (colorPickerMonture) {
        colorPickerMonture.addEventListener('input', (e) => {
          const target = e.target as HTMLInputElement;
          const customColor = target.value;
          currentColors.monture = customColor;
          currentConfig.couleurMonture = customColor;
          applySVGColors();
        });
      }

      if (colorPickerBranches) {
        colorPickerBranches.addEventListener('input', (e) => {
          const target = e.target as HTMLInputElement;
          const customColor = target.value;
          currentColors.branches = customColor;
          currentConfig.couleurBranches = customColor;
          applySVGColors();
        });
      }
    });

    // Gestion de la s√©lection des couleurs (cercles)
    document.addEventListener('click', (e) => {
      const colorButton = (e.target as HTMLElement).closest('button.rounded-full');
      if (!colorButton) return;

      // V√©rifier que c'est bien un bouton de couleur (qui a w-12 h-12)
      if (!colorButton.classList.contains('w-12') || !colorButton.classList.contains('h-12')) return;

      // Trouver le conteneur parent des couleurs (le flex gap-4)
      const colorContainer = colorButton.parentElement;
      if (!colorContainer) return;

      // R√©cup√©rer la couleur du bouton
      const color = window.getComputedStyle(colorButton).backgroundColor;
      
      // Convertir rgba en hex
      const rgbaMatch = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
      let hexColor = '#000000';
      if (rgbaMatch) {
        const r = parseInt(rgbaMatch[1]);
        const g = parseInt(rgbaMatch[2]);
        const b = parseInt(rgbaMatch[3]);
        hexColor = '#' + [r, g, b].map(x => {
          const hex = x.toString(16);
          return hex.length === 1 ? '0' + hex : hex;
        }).join('');
      }

      // D√©terminer quelle partie on colore (verres, monture, branches)
      const accordionContent = colorButton.closest('.accordion-content');
      if (!accordionContent) return;

      const accordionId = accordionContent.getAttribute('data-accordion-content');
      
      if (accordionId === 'couleur-verres') {
        currentColors.verres = hexColor;
        currentConfig.couleurVerres = hexColor;
      } else if (accordionId === 'couleur-monture') {
        currentColors.monture = hexColor;
        currentConfig.couleurMonture = hexColor;
      } else if (accordionId === 'couleur-branches') {
        currentColors.branches = hexColor;
        currentConfig.couleurBranches = hexColor;
      }

      // Appliquer les nouvelles couleurs
      applySVGColors();

      // D√©s√©lectionner tous les cercles de ce conteneur
      const allColors = colorContainer.querySelectorAll('button.rounded-full.w-12.h-12');
      allColors.forEach(btn => {
        if (btn.classList.contains('border-noir')) {
          btn.classList.remove('border-noir');
          btn.classList.add('border-border');
        }
      });

      // S√©lectionner le cercle cliqu√©
      colorButton.classList.remove('border-border');
      colorButton.classList.add('border-noir');
    });

    // Gestion de la taille
    const sizeIncrease = document.getElementById('size-increase');
    const sizeDecrease = document.getElementById('size-decrease');
    const sizeDisplay = document.getElementById('size-display');
    
    // Tailles disponibles
    const sizes = ['48-16', '50-17', '52-18', '54-19', '56-20'];
    let currentSizeIndex = 2; // Commence √† 52-18

    if (sizeIncrease && sizeDecrease && sizeDisplay) {
      sizeIncrease.addEventListener('click', () => {
        if (currentSizeIndex < sizes.length - 1) {
          currentSizeIndex++;
          sizeDisplay.textContent = sizes[currentSizeIndex];
          currentConfig.taille = sizes[currentSizeIndex];
          updateSizeButtons();
        }
      });

      sizeDecrease.addEventListener('click', () => {
        if (currentSizeIndex > 0) {
          currentSizeIndex--;
          sizeDisplay.textContent = sizes[currentSizeIndex];
          currentConfig.taille = sizes[currentSizeIndex];
          updateSizeButtons();
        }
      });

      function updateSizeButtons() {
        if (!sizeDecrease || !sizeIncrease) return;
        
        // D√©sactiver/activer les boutons selon la position
        if (currentSizeIndex === 0) {
          sizeDecrease.style.opacity = '0.3';
          sizeDecrease.style.cursor = 'not-allowed';
        } else {
          sizeDecrease.style.opacity = '1';
          sizeDecrease.style.cursor = 'pointer';
        }

        if (currentSizeIndex === sizes.length - 1) {
          sizeIncrease.style.opacity = '0.3';
          sizeIncrease.style.cursor = 'not-allowed';
        } else {
          sizeIncrease.style.opacity = '1';
          sizeIncrease.style.cursor = 'pointer';
        }
      }

      // Initialiser l'√©tat des boutons
      updateSizeButtons();
    }

    // Gestion de l'ouverture du modal infos uniquement
    const openInfoModal = document.getElementById('open-info-modal');
    const infoModal = document.getElementById('info-modal');

    if (openInfoModal && infoModal) {
      openInfoModal.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        infoModal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
      });
    }

    // Gestion du champ de nom de configuration
    const configNameInput = document.getElementById('config-name-input') as HTMLInputElement;
    if (configNameInput) {
      // Forcer la majuscule
      configNameInput.addEventListener('input', (e) => {
        const target = e.target as HTMLInputElement;
        target.value = target.value.toUpperCase();
      });
      
      // S√©lectionner tout le texte au focus
      configNameInput.addEventListener('focus', (e) => {
        const target = e.target as HTMLInputElement;
        target.select();
      });
    }
    
    // Le bouton "SAUVEGARDER LA CONFIGURATION" est maintenant g√©r√© par le script de sauvegarde
  </script>

  <!-- Script pour la sauvegarde de configuration -->
  <script>
    import { pb, saveConfiguration } from '../utils/pb';

    // Fonction pour afficher une notification
    function showNotification(message: string, type: 'success' | 'error') {
      const notification = document.createElement('div');
      notification.className = `fixed top-8 right-8 z-50 px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 ${
        type === 'success' 
          ? 'bg-vert text-white' 
          : 'bg-red-500 text-white'
      }`;
      notification.textContent = message;
      notification.style.transform = 'translateX(400px)';
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(0)';
      }, 10);
      
      setTimeout(() => {
        notification.style.transform = 'translateX(400px)';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Fonction qui effectue r√©ellement la sauvegarde (appel√©e par les boutons du modal)
    async function saveConfigurationAction(addToCart: boolean) {
      console.log('========================================');
      console.log('üöÄ SAUVEGARDE:', addToCart ? 'PANIER' : 'GALERIE');
      console.log('Authentifi√©:', pb.authStore.isValid);
      
      // V√©rifier l'authentification
      if (!pb.authStore.isValid) {
        console.error('‚ùå Non authentifi√©');
        showNotification('Vous devez √™tre connect√©', 'error');
        
        localStorage.setItem('pendingConfiguration', JSON.stringify({
          config: (window as any).currentConfig,
          colors: (window as any).currentColors,
          prix: (window as any).calculerPrixTotal(),
          addToCart: addToCart
        }));
        
        window.location.href = '/authentification?redirect=/configurateur&action=save';
        return;
      }

      const config = (window as any).currentConfig;
      const prix = (window as any).calculerPrixTotal();
      const nameInput = document.getElementById('config-name-input') as HTMLInputElement;
      const configName = nameInput?.value.trim() || '√âL√âGANCE';

      const configData = {
        nom: configName,
        description: `Lunettes ${config.formeMonture} en ${config.materiauNom} avec verres ${config.typeVerres}`,
        prix: prix,
        taille: config.taille,
        couleur_monture: config.couleurMonture,
        couleur_branches: config.couleurBranches,
        couleur_verres: config.couleurVerres,
        forme_monture: config.formeMonture,
        epaisseur_monture: config.epaisseur,
        types_verres: config.typeVerres,
        materiau_id: config.materiauId,
        est_dans_panier: addToCart,
      };

      console.log('üì¶ Donn√©es:', { nom: configData.nom, prix, est_dans_panier: addToCart });

      try {
        const result = await saveConfiguration(configData);
        console.log('üì• R√©sultat:', result.success ? '‚úÖ OK' : '‚ùå ERREUR');

        if (result.success) {
          // Fermer le modal
          const modal = document.getElementById('cart-modal');
          if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = 'auto';
          }
          
          const message = addToCart ? '‚úì Ajout√© au panier !' : '‚úì Configuration sauvegard√©e !';
          showNotification(message, 'success');
          
          console.log(`üîÑ Redirection vers ${addToCart ? '/panier' : '/galerie'}`);
          
          setTimeout(() => {
            window.location.href = addToCart ? '/panier' : '/galerie';
          }, 1500);
        } else {
          console.error('Erreur:', result.error);
          showNotification(result.error || 'Erreur lors de la sauvegarde', 'error');
        }
      } catch (error) {
        console.error('‚ùå Exception:', error);
        showNotification('Erreur lors de la sauvegarde', 'error');
      }
      
      console.log('========================================');
    }

    // Fonction pour sauvegarder la configuration (ancienne version - gard√©e pour compatibilit√©)
    async function handleSaveConfiguration() {
      console.log('D√©but de la sauvegarde...');
      console.log('Auth valide?', pb.authStore.isValid);
      console.log('User:', pb.authStore.model);
      
      // V√©rifier l'authentification - Afficher le modal d'authentification requise
      if (!pb.authStore.isValid) {
        console.log('Non connect√©, affichage du modal d\'authentification');
        
        // Stocker la configuration dans localStorage pour la r√©cup√©rer apr√®s connexion
        localStorage.setItem('pendingConfiguration', JSON.stringify({
          config: (window as any).currentConfig,
          colors: (window as any).currentColors,
          prix: (window as any).calculerPrixTotal()
        }));
        
        // Afficher le modal
        const modal = document.getElementById('auth-required-modal');
        if (modal) {
          modal.classList.remove('hidden');
          document.body.style.overflow = 'hidden';
        }
        return;
      }

      // R√©cup√©rer la configuration actuelle
      const config = (window as any).currentConfig;
      const prix = (window as any).calculerPrixTotal();
      
      // R√©cup√©rer le nom depuis l'input
      const nameInput = document.getElementById('config-name-input') as HTMLInputElement;
      const configName = nameInput?.value.trim() || '√âL√âGANCE';

      const configData = {
        nom: configName,
        description: `Lunettes ${config.formeMonture} avec verres ${config.typeVerres}`,
        prix: prix,
        taille: config.taille,
        couleur_monture: config.couleurMonture,
        couleur_branches: config.couleurBranches,
        couleur_verres: config.couleurVerres,
        forme_monture: config.formeMonture,
        epaisseur_monture: config.epaisseur,
        types_verres: config.typeVerres,
      };

      console.log('Donn√©es √† sauvegarder:', configData);

      try {
        const saveButton = document.getElementById('open-cart-modal');
        if (saveButton) {
          saveButton.style.opacity = '0.5';
          saveButton.style.pointerEvents = 'none';
        }

        const result = await saveConfiguration(configData);
        console.log('R√©sultat sauvegarde:', result);

        if (result.success) {
          showNotification('Configuration sauvegard√©e avec succ√®s !', 'success');
          setTimeout(() => {
            window.location.href = '/galerie';
          }, 1500);
        } else {
          showNotification('Erreur: ' + result.error, 'error');
          if (saveButton) {
            saveButton.style.opacity = '1';
            saveButton.style.pointerEvents = 'auto';
          }
        }
      } catch (error) {
        console.error('Erreur catch:', error);
        showNotification('Erreur lors de la sauvegarde', 'error');
        const saveButton = document.getElementById('open-cart-modal');
        if (saveButton) {
          saveButton.style.opacity = '1';
          saveButton.style.pointerEvents = 'auto';
        }
      }
    }

    // √âcouter le clic sur le bouton de sauvegarde - Ouvre le modal au lieu de sauvegarder directement
    document.addEventListener('DOMContentLoaded', () => {
      const openCartModal = document.getElementById('open-cart-modal');
      
      if (openCartModal) {
        openCartModal.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          
          // V√©rifier l'authentification d'abord
          if (!pb.authStore.isValid) {
            console.log('Non connect√©, affichage du modal d\'authentification');
            localStorage.setItem('pendingConfiguration', JSON.stringify({
              config: (window as any).currentConfig,
              colors: (window as any).currentColors,
              prix: (window as any).calculerPrixTotal()
            }));
            
            // Ouvrir le modal d'authentification
            const authModal = document.getElementById('auth-required-modal');
            if (authModal) {
              authModal.classList.remove('hidden');
              document.body.style.overflow = 'hidden';
            }
            return;
          }
          
          // R√©cup√©rer les donn√©es pour remplir le modal
          const config = (window as any).currentConfig;
          const prix = (window as any).calculerPrixTotal();
          const nameInput = document.getElementById('config-name-input') as HTMLInputElement;
          const configName = nameInput?.value.trim() || '√âL√âGANCE';
          
          // Remplir le modal avec les donn√©es
          document.getElementById('cart-config-name')!.textContent = configName;
          document.getElementById('cart-prix')!.textContent = prix.toString() + ' ‚Ç¨';
          document.getElementById('cart-size')!.textContent = config.taille;
          document.getElementById('cart-type-verres')!.textContent = config.typeVerres;
          document.getElementById('cart-forme')!.textContent = config.formeMonture;
          document.getElementById('cart-epaisseur')!.textContent = config.epaisseur;
          document.getElementById('cart-materiau')!.textContent = config.materiauNom;
          
          // Appliquer les couleurs au SVG du modal
          const modalSvgContainer = document.getElementById('modal-preview-container');
          if (modalSvgContainer) {
            const svg = modalSvgContainer.querySelector('svg');
            if (svg) {
              const currentColors = (window as any).currentColors;
              
              // Appliquer les couleurs des verres
              const verresGroup = svg.querySelector('#verres');
              if (verresGroup) {
                const verresPaths = verresGroup.querySelectorAll('path');
                verresPaths.forEach(path => {
                  (path as SVGPathElement).style.fill = currentColors.verres;
                  (path as SVGPathElement).style.opacity = '0.5';
                });
              }

              // Appliquer la couleur de la monture
              const montureGroup = svg.querySelector('#monture');
              if (montureGroup) {
                const monturePaths = montureGroup.querySelectorAll('path.cls-4');
                monturePaths.forEach(path => {
                  (path as SVGPathElement).style.fill = currentColors.monture;
                  (path as SVGPathElement).style.stroke = currentColors.monture;
                });
              }

              // Appliquer la couleur des branches
              const branchesGroup = svg.querySelector('#branches');
              if (branchesGroup) {
                const branchesPaths = branchesGroup.querySelectorAll('path.cls-4');
                branchesPaths.forEach(path => {
                  (path as SVGPathElement).style.fill = currentColors.branches;
                  (path as SVGPathElement).style.stroke = currentColors.branches;
                });
              }
            }
          }
          
          // Ouvrir le modal
          const modal = document.getElementById('cart-modal');
          if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
          }
        });
      }

      // Gestionnaires pour les boutons du modal - √âviter les doublons
      const saveOnlyBtn = document.getElementById('save-only-btn');
      const saveAndCartBtn = document.getElementById('save-and-cart-btn');
      
      console.log('Attachement des listeners aux boutons du modal');
      
      if (saveOnlyBtn) {
        // Cloner le bouton pour supprimer tous les anciens listeners
        const newSaveOnlyBtn = saveOnlyBtn.cloneNode(true) as HTMLElement;
        saveOnlyBtn.parentNode?.replaceChild(newSaveOnlyBtn, saveOnlyBtn);
        
        newSaveOnlyBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('üîπ CLIC: Sauvegarder uniquement');
          
          // D√©sactiver le bouton pendant le traitement
          newSaveOnlyBtn.style.pointerEvents = 'none';
          newSaveOnlyBtn.style.opacity = '0.6';
          
          await saveConfigurationAction(false);
          
          // R√©activer le bouton
          newSaveOnlyBtn.style.pointerEvents = 'auto';
          newSaveOnlyBtn.style.opacity = '1';
        });
      }
      
      if (saveAndCartBtn) {
        // Cloner le bouton pour supprimer tous les anciens listeners
        const newSaveAndCartBtn = saveAndCartBtn.cloneNode(true) as HTMLElement;
        saveAndCartBtn.parentNode?.replaceChild(newSaveAndCartBtn, saveAndCartBtn);
        
        newSaveAndCartBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('üõí CLIC: Ajouter au panier');
          
          // D√©sactiver le bouton pendant le traitement
          newSaveAndCartBtn.style.pointerEvents = 'none';
          newSaveAndCartBtn.style.opacity = '0.6';
          
          await saveConfigurationAction(true);
          
          // R√©activer le bouton
          newSaveAndCartBtn.style.pointerEvents = 'auto';
          newSaveAndCartBtn.style.opacity = '1';
        });
      }

      // Charger un mod√®le depuis l'URL
      const urlParams = new URLSearchParams(window.location.search);
      const modeleId = urlParams.get('modele');
      
      if (modeleId) {
        // Charger les donn√©es du mod√®le (depuis l'import dynamique)
        import('../data/modeles').then(({ getModeleById }) => {
          const modele = getModeleById(modeleId);
          if (modele) {
            console.log('üì¶ Chargement du mod√®le:', modele.nom);
            
            // Mettre √† jour le nom
            const nameInput = document.getElementById('config-name-input') as HTMLInputElement;
            if (nameInput) {
              nameInput.value = modele.nom;
            }
            
            // Mettre √† jour la configuration
            currentConfig.typeVerres = modele.typeVerres;
            currentConfig.formeMonture = modele.formeMonture;
            currentConfig.epaisseur = modele.epaisseur;
            currentConfig.taille = modele.taille;
            currentConfig.couleurMonture = modele.couleurMonture;
            currentConfig.couleurBranches = modele.couleurBranches;
            currentConfig.couleurVerres = modele.couleurVerres;
            
            // Mettre √† jour les couleurs
            currentColors.monture = modele.couleurMonture;
            currentColors.branches = modele.couleurBranches;
            currentColors.verres = modele.couleurVerres;
            
            // Appliquer les changements visuels
            if ((window as any).applySVGColors) {
              (window as any).applySVGColors();
            }
            if ((window as any).updatePriceDisplay) {
              (window as any).updatePriceDisplay();
            }
            
            // Nettoyer l'URL
            window.history.replaceState({}, document.title, '/configurateur');
          }
        });
      }
      
      // Restaurer configuration apr√®s connexion
      const action = urlParams.get('action');
      
      if (action === 'save' && pb.authStore.isValid) {
        const pendingConfig = localStorage.getItem('pendingConfiguration');
        
        if (pendingConfig) {
          const { config, colors } = JSON.parse(pendingConfig);
          (window as any).currentConfig = config;
          (window as any).currentColors = colors;
          
          if ((window as any).applySVGColors) {
            (window as any).applySVGColors();
          }
          if ((window as any).updatePriceDisplay) {
            (window as any).updatePriceDisplay();
          }
          
          localStorage.removeItem('pendingConfiguration');
          showNotification('Pr√™t √† sauvegarder votre configuration !', 'success');
          window.history.replaceState({}, document.title, '/configurateur');
        }
      }
    });
  </script>
</Layout>