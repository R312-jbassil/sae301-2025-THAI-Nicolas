---
interface Props {
  id: string;
}

const { id } = Astro.props;
---

<div id={id} class="modal-chat fixed bottom-0 left-0 z-50 hidden" style="transition: all 0.3s ease;">
  <div class="modal-chat-content bg-white rounded-t-3xl shadow-2xl w-[400px] h-[600px] relative flex flex-col border-2 border-vert border-b-0">
    <!-- Header -->
    <div class="bg-vert text-white px-4 py-3 rounded-t-3xl flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-white rounded-full flex items-center justify-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-vert" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </div>
        <div>
          <h3 class="font-bold text-base">Assistant IA</h3>
          <p class="text-xs text-white/80">En ligne</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <!-- Bouton Reset -->
        <button 
          id="reset-chat-btn"
          class="w-8 h-8 rounded-full hover:bg-white/20 transition-all duration-300 flex items-center justify-center"
          title="R√©initialiser la conversation"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
        </button>
        <!-- Bouton fermer -->
        <button class="modal-close w-8 h-8 rounded-full hover:bg-white/20 transition-all duration-300 flex items-center justify-center" data-modal={id}>
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Messages Container -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 bg-gray-50">
      <!-- Message de bienvenue -->
      <div class="flex gap-2 animate-slide-up">
        <div class="w-8 h-8 bg-vert rounded-full flex items-center justify-center shrink-0 mt-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </div>
        <div class="bg-white rounded-2xl rounded-tl-sm px-4 py-3 max-w-[85%] shadow-sm">
          <p class="text-sm text-noir leading-relaxed">
            Bonjour ! Je suis votre assistant pour vous aider √† choisir vos lunettes id√©ales. 
            Comment puis-je vous aider aujourd'hui ?
          </p>
        </div>
      </div>
    </div>

    <!-- Input Area -->
    <div class="p-4 border-t border-gray-200 bg-white">
      <div class="flex gap-2">
        <input 
          type="text" 
          id="chat-input"
          placeholder="√âcrivez votre message..."
          class="flex-1 border-2 border-gray-200 rounded-full px-4 py-2 text-sm focus:outline-none focus:border-vert transition-colors"
        />
        <button 
          id="chat-send-btn"
          class="bg-vert hover:bg-[#4a7d5f] text-white rounded-full w-10 h-10 flex items-center justify-center shrink-0 transition-all duration-300"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
          </svg>
        </button>
      </div>
      <p class="text-xs text-gris mt-2 text-center">Propuls√© par l'IA TaVue</p>
    </div>
  </div>
</div>

<style>
  /* Animation d'apparition */
  @keyframes slide-up {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-slide-up {
    animation: slide-up 0.3s ease-out;
  }

  /* Animation du chatbot */
  .modal-chat {
    transform: translateY(100%);
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .modal-chat.show {
    display: block !important;
    transform: translateY(0);
  }

  /* Scrollbar personnalis√©e */
  #chat-messages::-webkit-scrollbar {
    width: 6px;
  }

  #chat-messages::-webkit-scrollbar-track {
    background: transparent;
  }

  #chat-messages::-webkit-scrollbar-thumb {
    background: #d1d5db;
    border-radius: 10px;
  }

  #chat-messages::-webkit-scrollbar-thumb:hover {
    background: #9ca3af;
  }
</style>

<script>
  import { getChatConversation, addChatMessage, resetChatConversation, type ChatIA } from '../../utils/pb';

  // Historique de la conversation
  let conversationHistory: Array<{ role: string, content: string }> = [];
  let currentConversation: ChatIA | null = null;

  document.addEventListener('DOMContentLoaded', async () => {
    const chatInput = document.getElementById('chat-input') as HTMLInputElement;
    const sendBtn = document.getElementById('chat-send-btn') as HTMLButtonElement;
    const messagesContainer = document.getElementById('chat-messages') as HTMLElement;

    // Charger la conversation existante au chargement
    const result = await getChatConversation();
    if (result.success && result.conversation) {
      currentConversation = result.conversation;
      
      // Charger l'historique depuis PocketBase
      if (currentConversation.messages && currentConversation.messages.length > 0) {
        conversationHistory = currentConversation.messages.map(msg => ({
          role: msg.role,
          content: msg.content
        }));
        
        // Afficher les messages existants dans l'interface (sauf le message de bienvenue syst√®me)
        if (messagesContainer) {
          currentConversation.messages.forEach(msg => {
            if (msg.role !== 'system') {
              addMessageToUI(msg.content, msg.role === 'user', false); // false = ne pas sauvegarder
            }
          });
        }
      }
      
      console.log('üí¨ Conversation charg√©e:', currentConversation.id, 'avec', conversationHistory.length, 'messages');
    } else {
      console.error('‚ùå Erreur chargement conversation:', result.error);
    }

    // Fonction pour ajouter un message √† l'interface ET le sauvegarder dans PocketBase
    async function addMessage(content: string, isUser: boolean) {
      await addMessageToUI(content, isUser, true); // true = sauvegarder dans PocketBase
    }

    // Fonction pour ajouter un message uniquement √† l'interface (sans sauvegarder)
    async function addMessageToUI(content: string, isUser: boolean, saveToDb: boolean = false) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `flex gap-2 animate-slide-up ${isUser ? 'justify-end' : ''}`;

      if (isUser) {
        // Message utilisateur (√† droite)
        messageDiv.innerHTML = `
          <div class="bg-vert text-white rounded-2xl rounded-tr-sm px-4 py-3 max-w-[85%] shadow-sm">
            <p class="text-sm leading-relaxed">${content}</p>
          </div>
        `;
      } else {
        // Message IA (√† gauche)
        messageDiv.innerHTML = `
          <div class="w-8 h-8 bg-vert rounded-full flex items-center justify-center shrink-0 mt-1">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>
          <div class="bg-white rounded-2xl rounded-tl-sm px-4 py-3 max-w-[85%] shadow-sm">
            <p class="text-sm text-noir leading-relaxed">${content}</p>
          </div>
        `;
      }

      messagesContainer.appendChild(messageDiv);
      
      // Scroll automatique vers le bas
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Sauvegarder dans PocketBase si demand√©
      if (saveToDb && currentConversation) {
        const role = isUser ? 'user' : 'assistant';
        await addChatMessage(currentConversation.id, role, content);
      }
    }

    // Fonction pour afficher le loader
    function showLoader() {
      const loaderDiv = document.createElement('div');
      loaderDiv.className = 'flex gap-2 animate-slide-up';
      loaderDiv.id = 'typing-loader';
      loaderDiv.innerHTML = `
        <div class="w-8 h-8 bg-vert rounded-full flex items-center justify-center shrink-0 mt-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
        </div>
        <div class="bg-white rounded-2xl rounded-tl-sm px-4 py-3 shadow-sm">
          <div class="flex gap-1">
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0s"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
            <span class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
          </div>
        </div>
      `;
      messagesContainer.appendChild(loaderDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }

    // Fonction pour retirer le loader
    function removeLoader() {
      const loader = document.getElementById('typing-loader');
      if (loader) {
        loader.remove();
      }
    }

    // Fonction pour envoyer un message
    async function sendMessage() {
      const message = chatInput.value.trim();
      if (!message) return;

      // D√©sactiver l'input pendant l'envoi
      chatInput.disabled = true;
      sendBtn.disabled = true;

      // Ajouter le message utilisateur √† l'interface
      addMessage(message, true);
      
      // Ajouter √† l'historique
      conversationHistory.push({ role: 'user', content: message });

      // Vider l'input
      chatInput.value = '';

      // Afficher le loader
      showLoader();

      try {
        // Appeler l'API avec timeout
        console.log('Envoi du message:', message);
        
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 secondes timeout
        
        const response = await fetch('/api/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            message: message,
            conversationHistory: conversationHistory
          }),
          signal: controller.signal
        });
        
        clearTimeout(timeoutId);

        console.log('R√©ponse re√ßue, status:', response.status);
        const data = await response.json();
        console.log('Donn√©es JSON:', data);

        // Retirer le loader
        removeLoader();

        if (response.ok && data.message) {
          // Parser la r√©ponse JSON de l'IA
          try {
            const aiResponse = JSON.parse(data.message);
            
            if (aiResponse.action === 'modify' && aiResponse.changes) {
              // Appliquer les modifications au configurateur
              const changes = aiResponse.changes;
              
              // Acc√©der aux fonctions et variables du configurateur
              const currentConfig = (window as any).currentConfig;
              const currentColors = (window as any).currentColors;
              const applySVGColors = (window as any).applySVGColors;
              const updatePriceDisplay = (window as any).updatePriceDisplay;
              
              // Appliquer les changements de couleur
              if (changes.couleurVerres) {
                currentColors.verres = changes.couleurVerres;
                currentConfig.couleurVerres = changes.couleurVerres;
              }
              if (changes.couleurMonture) {
                currentColors.monture = changes.couleurMonture;
                currentConfig.couleurMonture = changes.couleurMonture;
              }
              if (changes.couleurBranches) {
                currentColors.branches = changes.couleurBranches;
                currentConfig.couleurBranches = changes.couleurBranches;
              }
              
              // Appliquer les changements de configuration
              if (changes.formeMonture) {
                currentConfig.formeMonture = changes.formeMonture.toLowerCase();
                updateSelectUI('forme-monture', changes.formeMonture);
              }
              if (changes.typeVerres) {
                currentConfig.typeVerres = changes.typeVerres.toLowerCase();
                updatePriceDisplay(); // Mettre √† jour le prix si le type de verres change
                updateSelectUI('type-verres', changes.typeVerres);
              }
              if (changes.epaisseur) {
                currentConfig.epaisseur = changes.epaisseur.toLowerCase();
                updateSelectUI('epaisseur', changes.epaisseur);
              }
              
              // Appliquer les couleurs au SVG
              applySVGColors();
              
              // Fonction pour mettre √† jour visuellement les selects
              function updateSelectUI(accordionId: string, value: string) {
                // Trouver le conteneur de l'accord√©on
                const accordionContent = document.querySelector(`[data-accordion-content="${accordionId}"]`);
                if (!accordionContent) return;
                
                // Trouver tous les boutons de s√©lection dans cet accord√©on
                const allButtons = accordionContent.querySelectorAll('button[data-value]');
                
                // D√©s√©lectionner tous les boutons
                allButtons.forEach(btn => {
                  btn.classList.remove('border-[#589772]', 'bg-[#f0f7f4]');
                  btn.classList.add('border-[#E8E8E8]', 'bg-white');
                  btn.setAttribute('aria-pressed', 'false');
                });
                
                // S√©lectionner le bon bouton (comparaison insensible √† la casse)
                allButtons.forEach(btn => {
                  const btnValue = btn.getAttribute('data-value')?.toLowerCase();
                  if (btnValue === value.toLowerCase()) {
                    btn.classList.remove('border-[#E8E8E8]', 'bg-white');
                    btn.classList.add('border-[#589772]', 'bg-[#f0f7f4]');
                    btn.setAttribute('aria-pressed', 'true');
                  }
                });
              }
              
              // Afficher le message de confirmation
              addMessage(aiResponse.message, false);
              conversationHistory.push({ role: 'assistant', content: data.message });
            } else if (aiResponse.action === 'clarify') {
              // L'IA demande des pr√©cisions
              addMessage(aiResponse.message, false);
              conversationHistory.push({ role: 'assistant', content: data.message });
            } else {
              // R√©ponse inattendue
              addMessage('Je n\'ai pas bien compris. Pouvez-vous reformuler ?', false);
            }
          } catch (parseError) {
            // Si ce n'est pas du JSON, afficher le message tel quel (fallback)
            addMessage(data.message, false);
            conversationHistory.push({ role: 'assistant', content: data.message });
          }
        } else {
          addMessage('D√©sol√©, une erreur s\'est produite. Veuillez r√©essayer.', false);
        }
      } catch (error: any) {
        console.error('Erreur compl√®te:', error);
        removeLoader();
        
        if (error.name === 'AbortError') {
          addMessage('La requ√™te a pris trop de temps. Veuillez r√©essayer avec une demande plus simple.', false);
        } else {
          addMessage('D√©sol√©, je ne peux pas r√©pondre pour le moment. Erreur: ' + error.message, false);
        }
      } finally {
        // R√©activer l'input
        chatInput.disabled = false;
        sendBtn.disabled = false;
        chatInput.focus();
      }
    }

    // √âcouter le clic sur le bouton d'envoi
    if (sendBtn) {
      sendBtn.addEventListener('click', sendMessage);
    }

    // √âcouter la touche Entr√©e
    if (chatInput) {
      chatInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendMessage();
        }
      });
    }

    // Bouton Reset
    const resetBtn = document.getElementById('reset-chat-btn');
    if (resetBtn) {
      resetBtn.addEventListener('click', async () => {
        // Ouvrir le modal de confirmation
        const modal = document.getElementById('reset-chat-confirm');
        if (!modal) return;
        
        modal.classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        
        // Attendre la r√©ponse
        const confirmed = await new Promise<boolean>((resolve) => {
          const confirmBtn = modal.querySelector('.modal-confirm-btn');
          const cancelBtn = modal.querySelector('.modal-cancel');
          const overlay = modal.querySelector('.modal-overlay');
          
          const close = (result: boolean) => {
            if (modal) {
              modal.classList.add('hidden');
              document.body.style.overflow = 'auto';
            }
            confirmBtn?.removeEventListener('click', handleConfirm);
            cancelBtn?.removeEventListener('click', handleCancel);
            overlay?.removeEventListener('click', handleOverlay);
            resolve(result);
          };
          
          const handleConfirm = () => close(true);
          const handleCancel = () => close(false);
          const handleOverlay = (e: Event) => {
            if (e.target === overlay) close(false);
          };
          
          confirmBtn?.addEventListener('click', handleConfirm);
          cancelBtn?.addEventListener('click', handleCancel);
          overlay?.addEventListener('click', handleOverlay);
        });
        
        if (!confirmed) return;

        try {
          // Cr√©er une nouvelle conversation
          const result = await resetChatConversation();
          
          if (result.success && result.newConversation) {
            // Mettre √† jour la conversation courante
            currentConversation = result.newConversation;
            conversationHistory = [];
            
            // Vider l'interface (garder seulement le message de bienvenue)
            if (messagesContainer) {
              // Garder seulement le premier message (bienvenue)
              const welcomeMessage = messagesContainer.firstElementChild;
              messagesContainer.innerHTML = '';
              if (welcomeMessage) {
                messagesContainer.appendChild(welcomeMessage);
              }
            }
            
            console.log('‚úÖ Conversation r√©initialis√©e');
            
            // Afficher un message de confirmation
            addMessageToUI('Conversation r√©initialis√©e ! Comment puis-je vous aider ?', false, false);
          } else {
            alert('Erreur lors de la r√©initialisation: ' + result.error);
          }
        } catch (error) {
          console.error('Erreur reset:', error);
          alert('Une erreur est survenue lors de la r√©initialisation.');
        }
      });
    }
  });
</script>
