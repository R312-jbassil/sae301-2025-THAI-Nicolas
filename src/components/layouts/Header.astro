---
import BoutonCirculaire from "../boutons/BoutonCirculaire.astro";
---

<header class="w-full">
  <div class="max-w-[1596px] mx-auto px-8 py-6">
    <div class="flex items-center justify-between gap-12">
      <!-- Logo à gauche -->
      <a href="/" class="flex items-center shrink-0 hover:opacity-80 transition-opacity duration-200">
        <img 
          src="/src/assets/icones/logo.svg" 
          alt="TaVue - Lunettes personnalisées" 
          class="w-[97px] h-auto"
        />
      </a>

      <!-- Navigation au centre -->
      <nav class="flex-1 flex justify-center">
        <ul class="flex items-center gap-16">
          <li>
            <a 
              href="/configurateur" 
              class="font-['Nunito_Sans'] font-normal text-[16px] text-gris uppercase tracking-[1.95px] hover:text-vert transition-colors duration-200"
            >
              Configurateur
            </a>
          </li>
          <li>
            <a 
              href="/galerie" 
              class="font-['Nunito_Sans'] font-normal text-[16px] text-gris uppercase tracking-[1.95px] hover:text-vert transition-colors duration-200"
            >
              Galerie
            </a>
          </li>
          <li>
            <a 
              href="/modeles" 
              class="font-['Nunito_Sans'] font-normal text-[16px] text-gris uppercase tracking-[1.95px] hover:text-vert transition-colors duration-200"
            >
              Modèles
            </a>
          </li>
        </ul>
      </nav>

      <!-- Zone compte à droite - affichage dynamique -->
      <div class="shrink-0 relative">
        <!-- Bouton non connecté -->
        <a href="/authentification" id="account-btn-guest" class="block">
          <BoutonCirculaire icone="compte" taille="big" ariaLabel="Mon compte" />
        </a>

        <!-- Menu utilisateur connecté (caché par défaut) -->
        <div id="account-menu" class="hidden">
          <!-- Avatar cliquable -->
          <button 
            id="avatar-btn"
            class="w-[58px] h-[58px] rounded-full overflow-hidden border-2 border-transparent hover:border-vert transition-all duration-200 focus:outline-none focus:border-vert"
            aria-label="Menu utilisateur"
          >
            <img 
              id="user-avatar"
              src=""
              alt="Avatar"
              class="w-full h-full object-cover"
            />
          </button>

          <!-- Menu déroulant -->
          <div 
            id="dropdown-menu"
            class="hidden absolute right-0 top-[70px] bg-white rounded-2xl shadow-lg border border-gray-100 py-2 min-w-[220px] z-50"
          >
            <!-- Info utilisateur -->
            <div class="px-6 py-4 border-b border-gray-100">
              <p id="user-name" class="font-semibold text-noir text-base"></p>
              <p id="user-email" class="text-gris text-sm mt-1"></p>
            </div>

            <!-- Menu items -->
            <div class="py-2">
              <a 
                href="/compte" 
                class="flex items-center gap-3 px-6 py-3 text-noir hover:bg-vert-light transition-colors duration-200"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span class="text-base">Mon profil</span>
              </a>

              <a 
                href="/galerie" 
                class="flex items-center gap-3 px-6 py-3 text-noir hover:bg-vert-light transition-colors duration-200"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span class="text-base">Mes créations</span>
              </a>

              <button 
                id="logout-btn"
                class="flex items-center gap-3 px-6 py-3 text-red-600 hover:bg-red-50 transition-colors duration-200 w-full text-left"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span class="text-base">Se déconnecter</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  import { pb, logout, getCurrentUser, isAuthenticated } from '../../utils/pb';

  // Vérifier l'état de connexion au chargement
  const guestBtn = document.getElementById('account-btn-guest');
  const accountMenu = document.getElementById('account-menu');
  const avatarBtn = document.getElementById('avatar-btn');
  const dropdownMenu = document.getElementById('dropdown-menu');
  const logoutBtn = document.getElementById('logout-btn');
  const userAvatar = document.getElementById('user-avatar') as HTMLImageElement;
  const userName = document.getElementById('user-name');
  const userEmail = document.getElementById('user-email');

  // Fonction pour mettre à jour l'affichage
  function updateHeaderUI() {
    if (isAuthenticated()) {
      const user = getCurrentUser();
      
      if (user && guestBtn && accountMenu) {
        // Cacher le bouton invité, afficher le menu utilisateur
        guestBtn.classList.add('hidden');
        accountMenu.classList.remove('hidden');

        // Mettre à jour les infos utilisateur
        if (userAvatar) {
          // Si l'utilisateur a un avatar, l'afficher, sinon avatar par défaut
          if (user.avatar) {
            userAvatar.src = pb.files.getUrl(user, user.avatar, { thumb: '100x100' });
          } else {
            // Avatar par défaut avec initiales
            userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.name || user.email)}&background=589772&color=ffffff&size=100`;
          }
        }

        if (userName) {
          userName.textContent = user.name || 'Utilisateur';
        }

        if (userEmail) {
          userEmail.textContent = user.email;
        }
      }
    } else {
      // Utilisateur non connecté
      if (guestBtn && accountMenu) {
        guestBtn.classList.remove('hidden');
        accountMenu.classList.add('hidden');
      }
    }
  }

  // Toggle du menu déroulant
  avatarBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    dropdownMenu?.classList.toggle('hidden');
  });

  // Fermer le menu en cliquant ailleurs
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (dropdownMenu && !dropdownMenu.contains(target) && target !== avatarBtn) {
      dropdownMenu.classList.add('hidden');
    }
  });

  // Gestion de la déconnexion
  logoutBtn?.addEventListener('click', async () => {
    logout();
    window.location.href = '/';
  });

  // Initialiser l'affichage
  updateHeaderUI();

  // Écouter les changements d'état d'authentification
  pb.authStore.onChange(() => {
    updateHeaderUI();
  });
</script>
