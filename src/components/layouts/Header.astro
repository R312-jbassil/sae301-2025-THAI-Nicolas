---
import BoutonCirculaire from "../boutons/BoutonCirculaire.astro";
---

<header class="w-full">
  <div class="max-w-[1596px] mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6">
    <div class="flex items-center justify-between gap-4 sm:gap-8 lg:gap-12">
      <!-- Logo √† gauche -->
      <a href="/" class="flex items-center shrink-0 hover:opacity-80 transition-opacity duration-200">
        <img 
          src="/logo.svg" 
          alt="TaVue - Lunettes personnalis√©es" 
          class="w-16 sm:w-20 lg:w-[97px] h-auto"
        />
      </a>

      <!-- Menu burger (visible sur mobile) -->
      <button id="mobile-menu-btn" class="md:hidden flex items-center justify-center w-10 h-10 cursor-pointer">
        <svg class="w-6 h-6 text-noir" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>

      <!-- Navigation au centre (cach√© sur mobile) -->
      <nav class="hidden md:flex flex-1 justify-center">
        <ul class="flex items-center gap-6 lg:gap-16">
          <li>
            <a 
              href="/modeles" 
              class="font-['Nunito_Sans'] font-normal text-sm lg:text-[16px] text-gris uppercase tracking-wide lg:tracking-[1.95px] hover:text-vert transition-colors duration-200"
            >
              Mod√®les
            </a>
          </li>
          <li>
            <a 
              href="/configurateur" 
              class="font-['Nunito_Sans'] font-normal text-sm lg:text-[16px] text-gris uppercase tracking-wide lg:tracking-[1.95px] hover:text-vert transition-colors duration-200"
            >
              Configurateur
            </a>
          </li>
          <li>
            <a 
              href="/galerie" 
              class="font-['Nunito_Sans'] font-normal text-sm lg:text-[16px] text-gris uppercase tracking-wide lg:tracking-[1.95px] hover:text-vert transition-colors duration-200"
            >
              Galerie
            </a>
          </li>
        </ul>
      </nav>

      <!-- Menu mobile (overlay) -->
      <div id="mobile-menu" class="hidden fixed inset-0 bg-black/50 z-50 md:hidden">
        <div class="absolute right-0 top-0 h-full w-64 bg-white shadow-xl">
          <div class="p-6">
            <button id="mobile-menu-close" class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center cursor-pointer">
              <svg class="w-6 h-6 text-noir" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
            
            <nav class="mt-12">
              <ul class="space-y-6">
                <li>
                  <a href="/modeles" class="block text-lg font-semibold text-noir hover:text-vert transition-colors">
                    Mod√®les
                  </a>
                </li>
                <li>
                  <a href="/configurateur" class="block text-lg font-semibold text-noir hover:text-vert transition-colors">
                    Configurateur
                  </a>
                </li>
                <li>
                  <a href="/galerie" class="block text-lg font-semibold text-noir hover:text-vert transition-colors">
                    Galerie
                  </a>
                </li>
              </ul>
            </nav>
          </div>
        </div>
      </div>

      <!-- Zone compte √† droite - affichage dynamique -->
      <div class="shrink-0 flex items-center gap-2 sm:gap-4">
        <!-- Bouton Panier -->
        <a href="/panier" class="relative group cursor-pointer">
          <div class="w-12 h-12 sm:w-[58px] sm:h-[58px] rounded-full bg-vert-light flex items-center justify-center hover:bg-vert transition-all duration-200 group-hover:scale-110">
            <img 
              src="/icones/panier.webp" 
              alt="Panier" 
              class="w-5 h-5 sm:w-6 sm:h-6 object-contain transition-all duration-200"
              style="filter: brightness(0.4) contrast(1.5);"
            />
          </div>
          <!-- Badge nombre d'articles (cach√© par d√©faut) -->
          <span 
            id="cart-badge" 
            class="hidden absolute -top-1 -right-1 w-5 h-5 sm:w-6 sm:h-6 bg-red-500 rounded-full text-white text-xs font-bold flex items-center justify-center"
          >
            0
          </span>
        </a>

        <!-- Zone compte -->
        <div class="relative">
          <!-- Bouton non connect√© -->
          <a href="/authentification" id="account-btn-guest" class="block cursor-pointer">
            <BoutonCirculaire icone="compte" taille="big" ariaLabel="Mon compte" />
          </a>

        <!-- Menu utilisateur connect√© (cach√© par d√©faut) -->
        <div id="account-menu" class="hidden">
          <!-- Avatar cliquable -->
          <button 
            id="avatar-btn"
            class="w-12 h-12 sm:w-[58px] sm:h-[58px] rounded-full overflow-hidden border-2 border-transparent hover:border-vert transition-all duration-200 focus:outline-none focus:border-vert cursor-pointer"
            aria-label="Menu utilisateur"
          >
            <img 
              id="user-avatar"
              src=""
              alt="Avatar"
              class="w-full h-full object-cover"
            />
          </button>

          <!-- Menu d√©roulant -->
          <div 
            id="dropdown-menu"
            class="hidden absolute right-0 top-14 sm:top-[70px] bg-white rounded-2xl shadow-lg border border-gray-100 py-2 min-w-[200px] sm:min-w-[220px] z-50"
          >
            <!-- Info utilisateur -->
            <div class="px-6 py-4 border-b border-gray-100">
              <p id="user-name" class="font-semibold text-noir text-base"></p>
              <p id="user-email" class="text-gris text-sm mt-1"></p>
            </div>

            <!-- Menu items -->
            <div class="py-2">
              <a 
                href="/compte" 
                class="flex items-center gap-3 px-6 py-3 text-noir hover:bg-vert-light transition-colors duration-200 cursor-pointer"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span class="text-base">Mon profil</span>
              </a>

              <a 
                href="/galerie" 
                class="flex items-center gap-3 px-6 py-3 text-noir hover:bg-vert-light transition-colors duration-200 cursor-pointer"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span class="text-base">Mes cr√©ations</span>
              </a>

              <button 
                id="logout-btn"
                class="flex items-center gap-3 px-6 py-3 text-red-600 hover:bg-red-50 transition-colors duration-200 w-full text-left cursor-pointer"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span class="text-base">Se d√©connecter</span>
              </button>
            </div>
          </div>
        </div>
        </div>
      </div>
    </div>
  </div>
</header>

<script>
  import { pb, logout, getCurrentUser, isAuthenticated } from '../../utils/pb';

  // V√©rifier l'√©tat de connexion au chargement
  const guestBtn = document.getElementById('account-btn-guest');
  const accountMenu = document.getElementById('account-menu');
  const avatarBtn = document.getElementById('avatar-btn');
  const dropdownMenu = document.getElementById('dropdown-menu');
  const logoutBtn = document.getElementById('logout-btn');
  const userAvatar = document.getElementById('user-avatar') as HTMLImageElement;
  const userName = document.getElementById('user-name');
  const userEmail = document.getElementById('user-email');

  // Fonction pour mettre √† jour l'affichage
  function updateHeaderUI() {
    if (isAuthenticated()) {
      const user = getCurrentUser();
      
      if (user && guestBtn && accountMenu) {
        // Cacher le bouton invit√©, afficher le menu utilisateur
        guestBtn.classList.add('hidden');
        accountMenu.classList.remove('hidden');

        // Mettre √† jour les infos utilisateur
        if (userAvatar) {
          // Si l'utilisateur a un avatar, l'afficher, sinon avatar par d√©faut
          if (user.avatar) {
            userAvatar.src = pb.files.getUrl(user, user.avatar, { thumb: '100x100' });
          } else {
            // Avatar par d√©faut avec initiales
            userAvatar.src = `https://ui-avatars.com/api/?name=${encodeURIComponent(user.nom || user.email)}&background=589772&color=ffffff&size=100`;
          }
        }

        if (userName) {
          userName.textContent = user.nom || 'Utilisateur';
        }

        if (userEmail) {
          userEmail.textContent = user.email;
        }
      }
    } else {
      // Utilisateur non connect√©
      if (guestBtn && accountMenu) {
        guestBtn.classList.remove('hidden');
        accountMenu.classList.add('hidden');
      }
    }
  }

  // Toggle du menu d√©roulant
  avatarBtn?.addEventListener('click', (e) => {
    e.stopPropagation();
    dropdownMenu?.classList.toggle('hidden');
  });

  // Fermer le menu en cliquant ailleurs
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    if (dropdownMenu && !dropdownMenu.contains(target) && target !== avatarBtn) {
      dropdownMenu.classList.add('hidden');
    }
  });

  // Gestion de la d√©connexion
  logoutBtn?.addEventListener('click', async () => {
    logout();
    window.location.href = '/';
  });

  // Initialiser l'affichage
  updateHeaderUI();

  // √âcouter les changements d'√©tat d'authentification
  pb.authStore.onChange(() => {
    updateHeaderUI();
  });

  // Fonction pour mettre √† jour le badge du panier
  async function updateCartBadge() {
    const cartBadge = document.getElementById('cart-badge');
    if (!cartBadge) return;

    if (isAuthenticated()) {
      try {
        const user = getCurrentUser();
        if (user?.id) {
          let count = 0;
          
          // Essayer d'abord avec la vue PocketBase
          try {
            const filter = `user_id = "${user.id}"`;
            const panierStats = await pb.collection("nombre_lunettes_panier").getFirstListItem(filter);
            count = panierStats?.nombre_lunettes || 0;
            if (import.meta.env.DEV) console.log('üîî Badge panier (depuis vue):', count);
          } catch (viewError) {
            // Fallback : compter directement dans configuration_lunettes
            if (import.meta.env.DEV) console.log('‚ö†Ô∏è Vue non accessible, comptage direct');
            const filter = `user_id = "${user.id}" && est_dans_panier = true`;
            const records = await pb.collection("configuration_lunettes").getList(1, 1, { filter });
            count = records.totalItems || 0;
            if (import.meta.env.DEV) console.log('üîî Badge panier (comptage direct):', count);
          }
          
          if (count > 0) {
            cartBadge.textContent = count.toString();
            cartBadge.classList.remove('hidden');
            cartBadge.classList.add('flex');
          } else {
            cartBadge.classList.add('hidden');
            cartBadge.classList.remove('flex');
          }
        }
      } catch (error) {
        console.error('‚ùå Erreur badge panier:', error);
        cartBadge.classList.add('hidden');
        cartBadge.classList.remove('flex');
      }
    } else {
      cartBadge.classList.add('hidden');
      cartBadge.classList.remove('flex');
    }
  }

  // Mettre √† jour le badge au chargement
  updateCartBadge();

  // √âcouter les changements d'authentification pour mettre √† jour le badge
  pb.authStore.onChange(() => {
    updateCartBadge();
  });

  // Rafra√Æchir le badge toutes les 5 secondes (optionnel)
  setInterval(updateCartBadge, 5000);

  // Gestion du menu mobile
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  const mobileMenuClose = document.getElementById('mobile-menu-close');

  mobileMenuBtn?.addEventListener('click', () => {
    mobileMenu?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  });

  mobileMenuClose?.addEventListener('click', () => {
    mobileMenu?.classList.add('hidden');
    document.body.style.overflow = 'auto';
  });

  // Fermer en cliquant sur l'overlay
  mobileMenu?.addEventListener('click', (e) => {
    if (e.target === mobileMenu) {
      mobileMenu.classList.add('hidden');
      document.body.style.overflow = 'auto';
    }
  });
</script>

<style>
  /* Rendre l'ic√¥ne panier blanche au hover */
  .group:hover img[alt="Panier"] {
    filter: brightness(0) invert(1) !important;
  }
</style>
